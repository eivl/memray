<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Example Applications for Memray" href="examples/README.html" /><link rel="prev" title="Python allocators" href="python_allocators.html" />

    <meta name="generator" content="sphinx-5.0.2, furo 2022.06.21"/>
        <title>Symbolic information in native mode - memray</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">memray</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/logo.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">The <code class="docutils literal notranslate"><span class="pre">run</span></code> subcommand</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_allocators.html">Python allocators</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Symbolic information in native mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/README.html">Example Applications for Memray</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Memray API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reporters</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="live.html">Live Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary.html">Summary Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="flamegraph.html">Flame Graph Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="table.html">Table Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="tree.html">Tree Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="stats.html">Stats Reporter</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="supported_environments.html">Supported environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="licenses.html">Licenses</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="symbolic-information-in-native-mode">
<h1>Symbolic information in native mode<a class="headerlink" href="#symbolic-information-in-native-mode" title="Permalink to this heading">#</a></h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>For the best native mode experience, we recommend running your program on
Linux using an interpreter and libraries built with as much debugging
information as possible.</p>
</div>
<p>When passing the <code class="docutils literal notranslate"><span class="pre">--native</span></code> flag to the <a class="reference internal" href="run.html"><span class="doc">the run subcommand</span></a>,
Memray will collect information about the native call stack leading to each
allocation, and it will dump it to the result file. This information is in
a raw form where every call is identified by a number called the “instruction
pointer” or “program counter”. The instruction pointer is a number that helps
running programs identify what CPU instruction needs to be executed next. After
fetching each instruction the instruction pointer is incremented, and holds the
memory address of (“points to”) the next instruction to be executed. Processors
usually fetch instructions sequentially from memory, but control transfer
instructions change the sequence by placing a new value in the instruction
pointer. These include branches (sometimes called jumps), subroutine calls, and
returns. A transfer that is performed only if some condition is true allows the
computer to follow a different sequence under different conditions.</p>
<p>When creating reports, Memray needs to convert these instruction pointers into
human readable information, like the function name, the file name where that
function is defined, and the line number within that file corresponding to the
instruction. This process is known as <strong>symbolification</strong>.</p>
<section id="how-memray-resolves-symbols">
<h2>How Memray resolves symbols<a class="headerlink" href="#how-memray-resolves-symbols" title="Permalink to this heading">#</a></h2>
<p>There are two different approaches Memray uses to symbolify an instruction
pointer:</p>
<ul class="simple">
<li><p>Use the <a class="reference external" href="https://dwarfstd.org/">DWARF</a> debugging information embedded in
the executable or shared library containing the instruction. This process
will provide function names, file names, and line numbers, and will also be
able to resolve inlined functions. This method is used whenever debugging
information is available.</p></li>
<li><p>Use the symbol table information embedded in the executable or shared library
containing the instruction. This is a suboptimal method that will <strong>only</strong>
provide function names, not file names or line numbers. It can also be
unreliable as the symbol table may not contain entries for every function.</p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>To reduce tracking overhead, Memray delays symbolification <strong>until reports
are being generated</strong>. This means that when a report is being generated,
Memray needs to read information from the interpreter executable that was
used to run the tracked application, and from the shared libraries that were
loaded into it. Reports must be generated <strong>on the same machine that the
application ran on</strong>, because the same versions of the interpreter and
shared libraries need to be available for inspection. Failing to do this
will result in symbolification errors or incorrect reports.</p>
</div>
<p>If Memray is able to resolve file names, line numbers, and inline functions,
it can hide some of the Python interpreter’s internal functions which don’t add
much information to the report. If there is no debug information available then
the produced flame graphs will look more noisy and be harder to read, because
we won’t be able to reliably detect these uninteresting functions. In these
images you can compare two flame-graphs, one with debug information and one
without debug information, produced from the same capture file:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><figure class="align-default" id="id1">
<img alt="_images/native_mode_no_debug.png" src="_images/native_mode_no_debug.png" />
<figcaption>
<p><span class="caption-text">Flamegraph in native mode produced without debug information.</span><a class="headerlink" href="#id1" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</td>
<td><figure class="align-default" id="id2">
<img alt="_images/native_mode_debug.png" src="_images/native_mode_debug.png" />
<figcaption>
<p><span class="caption-text">Flamegraph in native mode produced with debug information.</span><a class="headerlink" href="#id2" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</td>
</tr>
</tbody>
</table>
</div>
<p>You can see that file names are reported as <code class="docutils literal notranslate"><span class="pre">&lt;unknown&gt;</span></code> and line numbers as
<code class="docutils literal notranslate"><span class="pre">0</span></code> when debugging information is not available.</p>
<p>On Linux, you can check whether your binaries have DWARF debug information
available by running:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ readelf -S ./a.out <span class="p">|</span> grep debug
</pre></div>
</div>
</div></blockquote>
<p>For example, for checking if the Python interpreter has DWARF debug information
available:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ readelf -S <span class="k">$(</span>which python<span class="k">)</span> <span class="p">|</span> grep debug

<span class="o">[</span><span class="m">26</span><span class="o">]</span> .debug_aranges    PROGBITS         <span class="m">0000000000000000</span>  <span class="m">00001057</span>
<span class="o">[</span><span class="m">27</span><span class="o">]</span> .debug_info       PROGBITS         <span class="m">0000000000000000</span>  <span class="m">00001087</span>
<span class="o">[</span><span class="m">28</span><span class="o">]</span> .debug_abbrev     PROGBITS         <span class="m">0000000000000000</span>  000010de
<span class="o">[</span><span class="m">29</span><span class="o">]</span> .debug_line       PROGBITS         <span class="m">0000000000000000</span>  0000111a
<span class="o">[</span><span class="m">30</span><span class="o">]</span> .debug_str        PROGBITS         <span class="m">0000000000000000</span>  <span class="m">00001177</span>
<span class="o">[</span><span class="m">31</span><span class="o">]</span> .debug_macro      PROGBITS         <span class="m">0000000000000000</span>  00003eb1
</pre></div>
</div>
</div></blockquote>
</section>
<section id="symbolification-in-macos">
<span id="mac-symbolification"></span><h2>Symbolification in macOS<a class="headerlink" href="#symbolification-in-macos" title="Permalink to this heading">#</a></h2>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Because most most macOS binaries for Python don’t include debug
information, <strong>reports produced in macOS can be much less accurate</strong>.</p>
</div>
<p>On Mac OS X there was a decision to not have the linker include all of the
debug information into the executables and libraries it builds. Instead, the
compiler generates the DWARF debug information in the <code class="docutils literal notranslate"><span class="pre">.s</span></code> files, the
assembler outputs it in the <code class="docutils literal notranslate"><span class="pre">.o</span></code> files, and the linker includes a “debug map”
in the executable or shared library which tells debug info users where all of
the symbols were relocated during the link. There is a tool called <code class="docutils literal notranslate"><span class="pre">dsymutil</span></code>
that can read the debug map, load the DWARF information from the <code class="docutils literal notranslate"><span class="pre">.o</span></code> files,
relocate all the addresses and then output a single binary with all the DWARF
information at their final, linked addresses. This final binary is called
a <code class="docutils literal notranslate"><span class="pre">dSYM</span></code> bundle and is normally placed alongside every executable.</p>
<p>This process has some advantages, but unfortunately in the Python world neither
redistributors of Python interpreters nor library maintainers generally package
debugging information with the binaries. This means that <strong>most macOS binaries
don’t have debug information inside</strong>, so in general <strong>native mode
symbolification will not work well</strong> in macOS.</p>
<p>Memray will fall back to symbol table analysis if it can’t find any debug
information in the binary, but when producing reports we won’t be able to
identify where the different symbols came from, making flame graphs very
verbose and hard to read.</p>
<section id="adding-debugging-information-to-your-native-extension">
<h3>Adding debugging information to your native extension<a class="headerlink" href="#adding-debugging-information-to-your-native-extension" title="Permalink to this heading">#</a></h3>
<p>If you are debugging your own native extension, you can generate debug
information that Memray can use by executing <code class="docutils literal notranslate"><span class="pre">dsymutil</span></code> on your shared object
<strong>while the object files used to generate the shared object still exist</strong>. For
instance, for the Memray extension itself (the paths will be different for your
own extension):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sanity check: ensure that the object files are still around</span>

$ dsymutil -s  src/memray/_memray.cpython-310-darwin.so <span class="p">|</span> grep OSO <span class="p">|</span> head -n <span class="m">1</span>
<span class="o">[</span>  <span class="m">9431</span><span class="o">]</span> 000d39a1 <span class="m">66</span> <span class="o">(</span>N_OSO        <span class="o">)</span> <span class="m">00</span>     <span class="m">0001</span>   0000000062fb8052 <span class="s1">&#39;memray/build/temp.macosx-12.5-arm64-cpython-310/src/memray/_memray.o&#39;</span>

$ ls memray/build/temp.macosx-12.5-arm64-cpython-310/src/memray/_memray.o
.rw-r--r-- <span class="m">3</span>.5M pgalindo3 <span class="m">16</span> Aug <span class="m">12</span>:32 memray/build/temp.macosx-12.5-arm64-cpython-310/src/memray/_memray.o

<span class="c1"># Then generate a dSYM bundle with the debug information:</span>

$ dsymutil src/memray/_memray.cpython-310-darwin.so
</pre></div>
</div>
<p>This will place a new file called <code class="docutils literal notranslate"><span class="pre">_memray.cpython-310-darwin.dSYM</span></code> in the
same directory as the original shared object. Once this file is in place,
memray will be able to leverage the debug information it contains.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="examples/README.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Example Applications for Memray</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="python_allocators.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Python allocators</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Symbolic information in native mode</a><ul>
<li><a class="reference internal" href="#how-memray-resolves-symbols">How Memray resolves symbols</a></li>
<li><a class="reference internal" href="#symbolification-in-macos">Symbolification in macOS</a><ul>
<li><a class="reference internal" href="#adding-debugging-information-to-your-native-extension">Adding debugging information to your native extension</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/furo.js"></script>
    </body>
</html>